var b=null;
function f(a){f.h.constructor.call(this);this.options=f.q.R({host:document.location.hostname,port:4E3,ka:!1,T:["longPolling","JSONPLongPolling"]},a);this.ma={};this.C=f.t.I;this.ga=[];this.ja=new f.ba(this);this.D=b;this.V=[];this.k=new f.z(this.options);var c=this;this.k.S("message",function(a){var e=c.ja;if(a.l==void 0||a.D==void 0||a.id==void 0)e.f.log("Beseda receive incorrect message",a),e.f.d("error",a);else if(a.l.indexOf("/meta/")==0){var g=a.l.substr(6);!g in["connect","error","subscribe",
"unsubscribe"]?(e.f.log("Unsupported meta channel "+a.l),e.f.d("error",a)):e["_"+g].call(e,a)}else"successful"in a?(e.f.d("message:"+a.id,a.error,a),a.pa?e.f.log("Beseda publish to "+a.l,a):(e.f.log("Beseda publish request declined",a),e.f.d("error",a))):(e.f.log("Beseda get a new message from "+a.l,a),e.f.d("message:"+a.l,a.data,a),e.f.d("message",a.l,a.data,a))});this.k.S("error",function(){c.C=f.t.I;setTimeout(function(){c.v()},5E3)});this.J=b;this.F=function(a){c.D=a;a=h(c,"/meta/connect",c.J);
c.k.send(a);c.J=b;c.log("Beseda send connection request",a)}}f.j=function(){this.g={};this.fa=10};f.j.prototype.u=function(a,c){this.g[a]||(this.g[a]=[]);this.g[a].push(c);this.g[a].length>this.fa&&this.log("Warning: possible EventEmitter memory leak detected. "+this.g[a].length+" listeners added. Use emitter.setMaxListeners() to increase limit")};f.j.prototype.S=f.j.prototype.u;
f.j.prototype.d=function(){var a=Array.prototype.slice.call(arguments),c=a.shift();if(this.g[c])for(var d=0;d<this.g[c].length;d++)this.g[c][d].apply(this,a)};f.q={na:function(a){return this.R({},a)},R:function(a,c){for(var d in c)try{a[d]=c[d].constructor==Object?this.R(a[d],c[d]):c[d]}catch(e){a[d]=c[d]}return a},w:function(a,c){function d(){}d.prototype=c.prototype;a.prototype=new d;a.prototype.constructor=a;a.h=a.prototype.h=c.prototype;d=b}};f.q.w(f,f.j);
f.prototype.v=function(a,c){if(this.C==f.t.aa)return!1;this.C=f.t.CONNECTING;this.J=c;this.k.g.connect&&this.k.g.connect.indexOf(this.F)!==-1||this.k.u("connect",this.F);this.k.v();for(var d in this.V){var e=this.V[d];this.C==f.t.I||(this.C==f.t.CONNECTING?this.ga.push("/meta/subscribe",e):this.k.send(h(this,"/meta/subscribe",e)))}};f.prototype.log=function(){"console"in window&&"log"in console&&console.log.apply(console,arguments)};
function h(a,c,d){d=d||{};d.id=a.D+"_"+ ++f.ea;d.l=c;d.D=a.D;return d}f.t={I:0,CONNECTING:1,aa:2};f.ea=0;f.ba=function(a){this.f=a};f.z=function(a){f.z.h.constructor.call(this);this.K=a;this.M=f.a.ia(a);this.M.s=this};f.q.w(f.z,f.j);f.z.prototype.v=function(){this.M.v(this.K.host,this.K.port,this.K.ka)};f.z.prototype.send=function(a){for(var a=[].concat(a),c=[],d=0;d<a.length;d++)c.push(a[d].id);this.M.send(JSON.stringify(a),c)};f.a=function(){this.s=this.A=this.H=this.Q=b;this.L=[]};
f.a.ha={longPolling:"LongPolling",JSONPLongPolling:"JSONPLongPolling"};f.a.ia=function(a){for(var c=0;c<a.T.length;c++){var d=f.a[f.a.ha[a.T[c]]];if(d){if(d.$(a))return new d}else throw Error("Ivalid transport "+a.T[c]);}};f.a.prototype.v=function(){throw Error("Abstract method calling.");};f.a.prototype.send=function(){throw Error("Abstract method calling.");};f.a.prototype.N=function(a){this.A=a;for(this.s&&this.s.d("connect",this.A);this.L.length;)this.send(this.L.shift())};
f.a.prototype.O=function(a){if(a)for(;a.length;)this.s.d("message",a.shift())};f.a.c=function(){f.a.c.h.constructor.call(this);this.H="longPolling";this.G=this.p=this.o=this.B=b;this.X=this.Z="";this.Y();var a=this;this.F=function(c){a.N(c)};this.ca=function(c){a.O(c)};this.W=function(){a.s.d("error")};this.B.u("ready",this.F);this.o.u("ready",this.ca);this.B.u("error",this.W);this.o.u("error",this.W)};f.q.w(f.a.c,f.a);f.a.c.$=function(a){return document.location.hostname===a.host};
f.a.c.prototype.Y=function(){this.B=new f.a.c.m("GET");this.o=new f.a.c.m("GET");this.p=new f.a.c.m("PUT");this.G=new f.a.c.m("DELETE")};f.a.c.prototype.v=function(a,c,d){this.Q=(d?"https":"http")+"://"+a+":"+c+"/beseda/io";this.B.send(this.Q+"/"+this.H)};f.a.c.prototype.send=function(a,c){if(this.A){this.p.data=a;this.p.send();var d=this;this.p.S("error",function(a){for(var g=c.length-1;g>=0;)d.s.d("message:"+c[g],a),g--})}else this.L.push(a)};
f.a.c.prototype.N=function(a){if(a=this.P(a).oa)this.p.url=this.o.url=this.G.url=this.Q+"/"+this.H+"/"+a,this.p.url+=this.Z,this.G.url+=this.X,f.a.c.h.N.call(this,a),this.A&&this.o.send()};f.a.c.prototype.P=function(a){return JSON.parse(a)};f.a.c.prototype.O=function(a){a=this.P(a);f.a.c.h.O.call(this,a);this.A&&this.o.send()};f.a.c.m=function(a){f.a.c.m.h.constructor.call(this);this.url=b;this.method=a||"GET";this.data=b};f.q.w(f.a.c.m,f.j);
f.a.c.m.prototype.send=function(a){if(a)this.url=a;a=this.url;c!=b&&c.abort();var c=+"\u000b1"?new XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP"),d=this;c.onreadystatechange=function(){var a=c;if(a.readyState===4)a.status===200?d.d("ready",a.responseText):d.d("error"),a.onreadystatechange=b,a.abort()};this.method==="GET"&&this.data&&(a+=(a.indexOf("?")===-1?"?":"&")+this.data);c.open(this.method,encodeURI(a),!0);a=b;if(this.method!=="GET")a=this.data,c.setRequestHeader("Content-Type","application/x-www-form-urlencoded");
c.send(a)};f.a.b=function(){f.a.b.h.constructor.call(this);this.H="JSONPLongPolling";this.Z="/send";this.X="/destroy"};f.q.w(f.a.b,f.a.c);f.a.b.$=function(){return!0};f.a.b.prototype.Y=function(){this.B=new f.a.b.e;this.o=new f.a.b.e;this.p=new f.a.b.e;this.G=new f.a.b.e};f.a.b.prototype.P=function(a){return a};f.a.b.e=function(){f.a.b.e.h.constructor.call(this);this.url=b;this.data="";this.n=++f.a.b.e.da;this.i=0;this.r={};f.a.b.e.U[this.n]={}};f.q.w(f.a.b.e,f.j);f.a.b.e.U=[];f.a.b.e.da=0;
f.a.b.e.prototype.send=function(a){if(a)this.url=a;(function(a,d,e){f.a.b.e.U[d.n][a]=function(g){clearTimeout(e);console.log("request_"+d.n+"_"+a);document.body.removeChild(document.getElementById("request_"+d.n+"_"+a));delete d.r[a];d.d("ready",g)}})(this.i,this,function(a,d){return setTimeout(function(){document.body.removeChild(document.getElementById("request_"+d.n+"_"+a));delete d.r[a];d.d("error")},15E3)}(this.i,this));a=this.url;a+=(a.indexOf("?")===-1?"?":"&")+"callback=Beseda.Transport.JSONPLongPolling.JSONPRequest.__callbacks["+
this.n+"]["+this.i+"]&"+(new Date).getTime()+"&messages="+this.data;this.r[this.i]=document.createElement("script");this.r[this.i].src=a;this.r[this.i].id="request_"+this.n+"_"+this.i;document.body.appendChild(this.r[this.i]);this.data=b;this.i++};f.a.b.la=function(){f.a.b.e.h.constructor.call(this);this.url=b};
var Beseda=function(a){this.setOptions({socketIO:{host:document.location.hostname,port:document.location.port||80},log:function(){"console"in window&&"log"in console&&console.log.apply(console,arguments)}},a),this._events={},this._status=Beseda._statuses.DISCONNECTED,this._messageQueue=[],this.router=new Beseda.Router(this),this.clientId=Beseda.utils.uid();if(this.options.socketIO.constructor==Object){var b=Beseda.utils.cloneObject(this.options.socketIO),c=b.host;delete b.host,this.socketIO=new io.Socket(c,b)}else this.socketIO=this.options.socketIO;this.socketIO.on("message",this.router.dispatch.bind(this.router)),this.socketIO.on("reconnect",this._onReconnect.bind(this)),this.socketIO.on("disconnect",this._onDisconnect.bind(this))};Beseda.prototype.isConnected=function(){return this._status==Beseda._statuses.CONNECTED},Beseda.prototype.isDisconnected=function(){return this._status==Beseda._statuses.DISCONNECTED},Beseda.prototype.isConnecting=function(){return this._status==Beseda._statuses.CONNECTING},Beseda.prototype.subscribe=function(a,b,c){this.isDisconnected()&&this.connect();var d=c||{};d.subscription=a,d=this._sendMessage("/meta/subscribe",d),this.log("Send subscribe request",d),b&&this.on("subscribe:"+d.id,b);return this},Beseda.prototype.unsubscribe=function(a,b,c){this.isDisconnected()&&this.connect();var d=c||{};d.subscription=a,d=this._sendMessage("/meta/unsubscribe",d),this.log("Send unsubscribe request",d),b&&this.on("unsubscribe:"+d.id,b);return this},Beseda.prototype.publish=function(a,b,c){this.isDisconnected()&&this.connect(),b=this._sendMessage(a,{data:b}),this.log("Send publish request",b),c&&this.on("message:"+a+":"+b.id,c);return this},Beseda.prototype.connect=function(a,b){if(this.isConnected())return!1;this._status=Beseda._statuses.CONNECTING,this.socketIO.connect();var c=this._createMessage("/meta/connect",b);this.socketIO.send(c),this.log("Send connection request",c);return this},Beseda.prototype.disconnect=function(){this.socketIO.disconnect()},Beseda.prototype.setOptions=function(a,b){this.options=Beseda.utils.mergeObjects(a,b)},Beseda.prototype.log=function(){this.options.log.apply(this,arguments)},Beseda.prototype._sendMessage=function(a,b){if(this.isDisconnected())throw"You must connect before send message";b=this._createMessage(a,b),this.isConnecting()?this._messageQueue.push(b):this.socketIO.send(b);return b},Beseda.prototype._createMessage=function(a,b){b=b||{},b.id=Beseda.utils.uid(),b.channel=a,b.clientId=this.clientId;return b},Beseda.prototype._onReconnect=function(){this.log("Beseda reconnected"),this.emit("reconnect")},Beseda.prototype._onDisconnect=function(){this._status==Beseda._statuses.DISCONNECTED,this.emit("disconnect"),this.log("Beseda disconnected")},Beseda._statuses={DISCONNECTED:0,CONNECTING:1,CONNECTED:2},Beseda.prototype.on=function(a,b){a in this._events||(this._events[a]=[]),this._events[a].push(b)},Beseda.prototype.addListener=Beseda.prototype.on,Beseda.prototype.removeListener=function(a,b){if(a in this._events)for(var c=0;c<this._events[a].length;c++)this._events[a][c]==b&&this._events[a].splice(c,1)},Beseda.prototype.removeAllListeners=function(a){a in this._events&&(this._events[a]=[])},Beseda.prototype.emit=function(){var a=Array.prototype.slice.call(arguments),b=a.shift();if(b in this._events)for(var c=0;c<this._events[b].length;c++)this._events[b][c].apply(this,a)},Beseda.prototype.listeners=function(a){return a in this._events?this._events[a]:[]},Beseda.Router=function(a){this.client=a},Beseda.Router.prototype.dispatch=function(a){if(a.channel==undefined||a.clientId==undefined||a.id==undefined)this.client.log("Beseda receive incorrect message",a),this.client.emit("error",a);else if(a.channel.indexOf("/meta/")==0){var b=a.channel.substr(6);!b in["connect","error","subscribe","unsubscribe"]&&(this.client.log("Unsupported meta channel "+a.channel),this.client.emit("error",a)),this["_"+b].call(this,a)}else this._message(a)},Beseda.Router.prototype._connect=function(a){a.successful?(this.client._status=Beseda._statuses.CONNECTED,this.client.socketIO.send(this.client._messageQueue),this.client.log("Beseda connected")):(this.client.disconnect(),this.client.log("Beseda connection request declined",a),this.client.emit("error",a)),this.client._messageQueue=[],this.client.emit("connection",a)},Beseda.Router.prototype._error=function(a){this.client.log("Beseda error: "+a.data),this.client.emit("error",a)},Beseda.Router.prototype._subscribe=function(a){a.successful?this.client.log("Beseda subscribed to "+a.subscription.toString(),a):(this.client.log("Beseda subscribe request declined",a),this.client.emit("error",a)),this.client.emit("subscribe",a.error,a),this.client.emit("subscribe:"+a.id,a.error,a)},Beseda.Router.prototype._unsubscribe=function(a){a.successful?this.client.log("Beseda unsubscribed from "+a.subscription.toString(),a):(this.client.log("Beseda unsubscribe request declined",a),this.client.emit("error",a)),this.client.emit("unsubscribe",a.error,a),this.client.emit("unsubscribe:"+a.id,a.error,a)},Beseda.Router.prototype._message=function(a){"successful"in a?(this.client.emit("message:"+a.channel+":"+a.id,a.error,a),a.successful?this.client.log("Beseda publish to "+a.channel,a):(this.client.log("Beseda publish request declined",a),this.client.emit("error",a))):(this.client.log("Beseda get a new message from "+a.channel,a),this.client.emit("message:"+a.channel,a.data,a),this.client.emit("message",a.channel,a.data,a))},Beseda.utils={uid:function(){var a="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz-_".split(""),b=[];for(var c=0;c<22;c++)b[c]=a[0|Math.random()*64];return b.join("")},cloneObject:function(a){return this.mergeObjects({},a)},mergeObjects:function(a,b){for(var c in b)try{b[c].constructor==Object?a[c]=this.mergeObjects(a[c],b[c]):a[c]=b[c]}catch(d){a[c]=b[c]}return a}}
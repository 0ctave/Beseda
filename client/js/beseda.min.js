var b=null,h;h||(h={});
(function(){function a(a){return a<10?"0"+a:a}function c(a){e.lastIndex=0;return e.test(a)?'"'+a.replace(e,function(a){var d=s[a];return typeof d==="string"?d:"\\u"+("0000"+a.charCodeAt(0).toString(16)).slice(-4)})+'"':'"'+a+'"'}function d(a,f){var k,e,m,o,p=j,i,g=f[a];g&&typeof g==="object"&&typeof g.toJSON==="function"&&(g=g.toJSON(a));typeof n==="function"&&(g=n.call(f,a,g));switch(typeof g){case "string":return c(g);case "number":return isFinite(g)?String(g):"null";case "boolean":case "null":return String(g);case "object":if(!g)return"null";
j+=q;i=[];if(Object.prototype.toString.apply(g)==="[object Array]"){o=g.length;for(k=0;k<o;k+=1)i[k]=d(k,g)||"null";m=i.length===0?"[]":j?"[\n"+j+i.join(",\n"+j)+"\n"+p+"]":"["+i.join(",")+"]";j=p;return m}if(n&&typeof n==="object"){o=n.length;for(k=0;k<o;k+=1)typeof n[k]==="string"&&(e=n[k],(m=d(e,g))&&i.push(c(e)+(j?": ":":")+m))}else for(e in g)Object.prototype.hasOwnProperty.call(g,e)&&(m=d(e,g))&&i.push(c(e)+(j?": ":":")+m);m=i.length===0?"{}":j?"{\n"+j+i.join(",\n"+j)+"\n"+p+"}":"{"+i.join(",")+
"}";j=p;return m}}if(typeof Date.prototype.toJSON!=="function")Date.prototype.toJSON=function(){return isFinite(this.valueOf())?this.getUTCFullYear()+"-"+a(this.getUTCMonth()+1)+"-"+a(this.getUTCDate())+"T"+a(this.getUTCHours())+":"+a(this.getUTCMinutes())+":"+a(this.getUTCSeconds())+"Z":b},String.prototype.toJSON=Number.prototype.toJSON=Boolean.prototype.toJSON=function(){return this.valueOf()};var f=/[\u0000\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,
e=/[\\\"\x00-\x1f\x7f-\x9f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,j,q,s={"\u0008":"\\b","\t":"\\t","\n":"\\n","\u000c":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"},n;if(typeof h.stringify!=="function")h.stringify=function(a,c,f){var e;q=j="";if(typeof f==="number")for(e=0;e<f;e+=1)q+=" ";else typeof f==="string"&&(q=f);if((n=c)&&typeof c!=="function"&&(typeof c!=="object"||typeof c.length!=="number"))throw Error("JSON.stringify");return d("",{"":a})};
if(typeof h.parse!=="function")h.parse=function(a,d){function c(a,f){var e,i,g=a[f];if(g&&typeof g==="object")for(e in g)Object.prototype.hasOwnProperty.call(g,e)&&(i=c(g,e),i!==void 0?g[e]=i:delete g[e]);return d.call(a,f,g)}var e,a=String(a);f.lastIndex=0;f.test(a)&&(a=a.replace(f,function(a){return"\\u"+("0000"+a.charCodeAt(0).toString(16)).slice(-4)}));if(/^[\],:{}\s]*$/.test(a.replace(/\\(?:["\\\/bfnrt]|u[0-9a-fA-F]{4})/g,"@").replace(/"[^"\\\n\r]*"|true|false|null|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?/g,
"]").replace(/(?:^|:|,)(?:\s*\[)+/g,"")))return e=eval("("+a+")"),typeof d==="function"?c({"":e},""):e;throw new SyntaxError("JSON.parse");}})();
function l(a){l.h.constructor.call(this);this.options=l.q.R({host:document.location.hostname,port:4E3,la:!1,T:["longPolling","JSONPLongPolling"]},a);this.na={};this.C=l.u.I;this.ha=[];this.ka=new l.ba(this);this.D=b;this.V=[];this.l=new l.z(this.options);var c=this;this.l.S("message",function(a){var f=c.ka;if(a.m==void 0||a.D==void 0||a.id==void 0)f.g.log("Beseda receive incorrect message",a),f.g.e("error",a);else if(a.m.indexOf("/meta/")==0){var e=a.m.substr(6);!e in["connect","error","subscribe",
"unsubscribe"]?(f.g.log("Unsupported meta channel "+a.m),f.g.e("error",a)):f["_"+e].call(f,a)}else"successful"in a?(f.g.e("message:"+a.id,a.error,a),a.qa?f.g.log("Beseda publish to "+a.m,a):(f.g.log("Beseda publish request declined",a),f.g.e("error",a))):(f.g.log("Beseda get a new message from "+a.m,a),f.g.e("message:"+a.m,a.data,a),f.g.e("message",a.m,a.data,a))});this.l.S("error",function(){c.C=l.u.I;setTimeout(function(){c.v()},5E3)});this.J=b;this.F=function(a){c.D=a;a=r(c,"/meta/connect",c.J);
c.l.send(a);c.J=b;c.log("Beseda send connection request",a)}}l.k=function(){this.d={};this.ga=10};l.k.prototype.p=function(a,c){this.d[a]||(this.d[a]=[]);this.d[a].push(c);this.d[a].length>this.ga&&this.log("Warning: possible EventEmitter memory leak detected. "+this.d[a].length+" listeners added. Use emitter.setMaxListeners() to increase limit")};l.k.prototype.S=l.k.prototype.p;
function t(a,c){function d(){c.apply(a,arguments);var f=d;if(a.d.error)for(var e=0;e<a.d.error.length;e++)a.d.error[e]===f&&a.d.error.splice(e,1)}a.S("error",d)}l.k.prototype.e=function(){var a=Array.prototype.slice.call(arguments),c=a.shift();if(this.d[c])for(var d=0;d<this.d[c].length;d++)this.d[c][d].apply(this,a)};
l.q={oa:function(a){return this.R({},a)},R:function(a,c){for(var d in c)try{a[d]=c[d].constructor==Object?this.R(a[d],c[d]):c[d]}catch(f){a[d]=c[d]}return a},w:function(a,c){function d(){}d.prototype=c.prototype;a.prototype=new d;a.prototype.constructor=a;a.h=a.prototype.h=c.prototype;d=b}};l.q.w(l,l.k);
l.prototype.v=function(a,c){if(this.C==l.u.aa)return!1;this.C=l.u.CONNECTING;this.J=c;this.l.d.connect&&this.l.d.connect.indexOf(this.F)!==-1||this.l.p("connect",this.F);this.l.v();for(var d in this.V){var f=this.V[d];this.C==l.u.I||(this.C==l.u.CONNECTING?this.ha.push("/meta/subscribe",f):this.l.send(r(this,"/meta/subscribe",f)))}};l.prototype.log=function(){};function r(a,c,d){d=d||{};d.id=a.D+"_"+ ++l.fa;d.m=c;d.D=a.D;return d}l.u={I:0,CONNECTING:1,aa:2};l.fa=0;l.ba=function(a){this.g=a};
l.z=function(a){l.z.h.constructor.call(this);this.K=a;this.M=l.a.ja(a);this.M.t=this};l.q.w(l.z,l.k);l.z.prototype.v=function(){this.M.v(this.K.host,this.K.port,this.K.la)};l.z.prototype.send=function(a){for(var a=[].concat(a),c=[],d=0;d<a.length;d++)c.push(a[d].id);this.M.send(h.stringify(a),c)};l.a=function(){this.t=this.A=this.H=this.Q=b;this.L=[]};l.a.ia={longPolling:"LongPolling",JSONPLongPolling:"JSONPLongPolling"};
l.a.ja=function(a){for(var c=0;c<a.T.length;c++){var d=l.a[l.a.ia[a.T[c]]];if(d){if(d.$(a))return new d}else throw Error("Ivalid transport "+a.T[c]);}};l.a.prototype.v=function(){throw Error("Abstract method calling.");};l.a.prototype.send=function(){throw Error("Abstract method calling.");};l.a.prototype.N=function(a){this.A=a;for(this.t&&this.t.e("connect",this.A);this.L.length;)this.send(this.L.shift())};l.a.prototype.O=function(a){if(a)for(;a.length;)this.t.e("message",a.shift())};
l.a.c=function(){l.a.c.h.constructor.call(this);this.H="longPolling";this.G=this.j=this.o=this.B=b;this.X=this.Z="";this.Y();var a=this;this.F=function(c){a.N(c)};this.ca=function(c){a.O(c)};this.W=function(){a.t.e("error")};this.da=function(){a.j.d.error=[]};this.B.p("ready",this.F);this.B.p("error",this.W);this.o.p("ready",this.ca);this.o.p("error",this.W);this.j.p("ready",this.da)};l.q.w(l.a.c,l.a);l.a.c.$=function(a){return document.location.hostname===a.host};
l.a.c.prototype.Y=function(){this.B=new l.a.c.n("GET");this.o=new l.a.c.n("GET");this.j=new l.a.c.n("PUT");this.G=new l.a.c.n("DELETE")};l.a.c.prototype.v=function(a,c,d){this.Q=(d?"https":"http")+"://"+a+":"+c+"/beseda/io";this.B.send(this.Q+"/"+this.H)};l.a.c.prototype.send=function(a,c){if(this.A){this.j.data=a;this.j.send();var d=this;t(this.j,function(a){for(var e=c.length-1;e>=0;)d.t.e("message:"+c[e],a),e--})}else this.L.push(a)};
l.a.c.prototype.N=function(a){if(a=this.P(a).pa)this.j.url=this.o.url=this.G.url=this.Q+"/"+this.H+"/"+a,this.j.url+=this.Z,this.G.url+=this.X,l.a.c.h.N.call(this,a),this.A&&this.o.send()};l.a.c.prototype.P=function(a){return h.parse(a)};l.a.c.prototype.O=function(a){a=this.P(a);l.a.c.h.O.call(this,a);this.A&&this.o.send()};l.a.c.n=function(a){l.a.c.n.h.constructor.call(this);this.url=b;this.method=a||"GET";this.data=b};l.q.w(l.a.c.n,l.k);
l.a.c.n.prototype.send=function(a){if(a)this.url=a;a=this.url+"/"+(new Date).getTime();c!=b&&c.abort();var c=+"\u000b1"?new XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP"),d=this;c.onreadystatechange=function(){var a=c;if(a.readyState===4)a.status===200?d.e("ready",a.responseText):d.e("error"),a.onreadystatechange=b,a.abort()};this.method==="GET"&&this.data&&(a+=(a.indexOf("?")===-1?"?":"&")+this.data);c.open(this.method,encodeURI(a),!0);a=b;if(this.method!=="GET")a=this.data,c.setRequestHeader("Content-Type",
"application/x-www-form-urlencoded");c.send(a)};l.a.b=function(){l.a.b.h.constructor.call(this);this.H="JSONPLongPolling";this.Z="/send";this.X="/destroy"};l.q.w(l.a.b,l.a.c);l.a.b.$=function(){return!0};l.a.b.prototype.Y=function(){this.B=new l.a.b.f;this.o=new l.a.b.f;this.j=new l.a.b.f;this.G=new l.a.b.f};l.a.b.prototype.P=function(a){return a};l.a.b.f=function(){l.a.b.f.h.constructor.call(this);this.url=b;this.data="";this.r=++l.a.b.f.ea;this.i=0;this.s={};l.a.b.f.U[this.r]={}};
l.q.w(l.a.b.f,l.k);l.a.b.f.U=[];l.a.b.f.ea=0;
l.a.b.f.prototype.send=function(a){if(a)this.url=a;(function(a,d,f){l.a.b.f.U[d.r][a]=function(e){clearTimeout(f);document.body.removeChild(document.getElementById("request_"+d.r+"_"+a));delete d.s[a];d.e("ready",e)}})(this.i,this,function(a,d){return setTimeout(function(){document.body.removeChild(document.getElementById("request_"+d.r+"_"+a));delete d.s[a];d.e("error")},15E3)}(this.i,this));a=this.url+"/"+(new Date).getTime();a+=(a.indexOf("?")===-1?"?":"&")+"callback=Beseda.Transport.JSONPLongPolling.JSONPRequest.__callbacks["+
this.r+"]["+this.i+"]&"+(new Date).getTime()+"&messages="+this.data;this.s[this.i]=document.createElement("script");this.s[this.i].src=a;this.s[this.i].id="request_"+this.r+"_"+this.i;document.body.appendChild(this.s[this.i]);this.data=b;this.i++};l.a.b.ma=function(){l.a.b.f.h.constructor.call(this);this.url=b};
var JSON;JSON||(JSON={});
(function(){function a(a){return a<10?"0"+a:a}function b(a){e.lastIndex=0;return e.test(a)?'"'+a.replace(e,function(a){var b=o[a];return typeof b==="string"?b:"\\u"+("0000"+a.charCodeAt(0).toString(16)).slice(-4)})+'"':'"'+a+'"'}function c(a,d){var e,k,i,l,m=g,h,f=d[a];f&&typeof f==="object"&&typeof f.toJSON==="function"&&(f=f.toJSON(a));typeof j==="function"&&(f=j.call(d,a,f));switch(typeof f){case "string":return b(f);case "number":return isFinite(f)?String(f):"null";case "boolean":case "null":return String(f);case "object":if(!f)return"null";
g+=n;h=[];if(Object.prototype.toString.apply(f)==="[object Array]"){l=f.length;for(e=0;e<l;e+=1)h[e]=c(e,f)||"null";i=h.length===0?"[]":g?"[\n"+g+h.join(",\n"+g)+"\n"+m+"]":"["+h.join(",")+"]";g=m;return i}if(j&&typeof j==="object"){l=j.length;for(e=0;e<l;e+=1)typeof j[e]==="string"&&(k=j[e],(i=c(k,f))&&h.push(b(k)+(g?": ":":")+i))}else for(k in f)Object.prototype.hasOwnProperty.call(f,k)&&(i=c(k,f))&&h.push(b(k)+(g?": ":":")+i);i=h.length===0?"{}":g?"{\n"+g+h.join(",\n"+g)+"\n"+m+"}":"{"+h.join(",")+
"}";g=m;return i}}if(typeof Date.prototype.toJSON!=="function")Date.prototype.toJSON=function(){return isFinite(this.valueOf())?this.getUTCFullYear()+"-"+a(this.getUTCMonth()+1)+"-"+a(this.getUTCDate())+"T"+a(this.getUTCHours())+":"+a(this.getUTCMinutes())+":"+a(this.getUTCSeconds())+"Z":"null"},String.prototype.toJSON=Number.prototype.toJSON=Boolean.prototype.toJSON=function(){return this.valueOf()};var d=/[\u0000\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,
e=/[\\\"\x00-\x1f\x7f-\x9f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,g,n,o={"\u0008":"\\b","\t":"\\t","\n":"\\n","\u000c":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"},j;if(typeof JSON.stringify!=="function")JSON.stringify=function(a,b,d){var e;n=g="";if(typeof d==="number")for(e=0;e<d;e+=1)n+=" ";else typeof d==="string"&&(n=d);if((j=b)&&typeof b!=="function"&&(typeof b!=="object"||typeof b.length!=="number"))throw Error("JSON.stringify");return c("",
{"":a})};if(typeof JSON.parse!=="function")JSON.parse=function(a,b){function c(a,e){var d,g,f=a[e];if(f&&typeof f==="object")for(d in f)Object.prototype.hasOwnProperty.call(f,d)&&(g=c(f,d),g!==void 0?f[d]=g:delete f[d]);return b.call(a,e,f)}var e,a=String(a);d.lastIndex=0;d.test(a)&&(a=a.replace(d,function(a){return"\\u"+("0000"+a.charCodeAt(0).toString(16)).slice(-4)}));if(/^[\],:{}\s]*$/.test(a.replace(/\\(?:["\\\/bfnrt]|u[0-9a-fA-F]{4})/g,"@").replace(/"[^"\\\n\r]*"|true|false|null|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?/g,
"]").replace(/(?:^|:|,)(?:\s*\[)+/g,"")))return e=eval("("+a+")"),typeof b==="function"?c({"":e},""):e;throw new SyntaxError("JSON.parse");}})();var beseda={utils:{},events:{},transport:{}};beseda.transport.request={};beseda.events.EventEmitter=function(){};beseda.events.EventEmitter.defaultMaxListeners=10;beseda.events.EventEmitter.isArray=Array.isArray||function(a){return Object.prototype.toString.call(a)==="[object Array]"};
beseda.events.EventEmitter.prototype.setMaxListeners=function(a){if(!this._events)this._events={};this._events.maxListeners=a};
beseda.events.EventEmitter.prototype.emit=function(a){if(a==="error"&&(!this._events||!this._events.error||beseda.events.EventEmitter.isArray(this._events.error)&&!this._events.error.length))if(arguments[1]instanceof Error)throw arguments[1];else throw Error("Uncaught, unspecified 'error' event.");if(!this._events)return!1;var b=this._events[a];if(!b)return!1;if(typeof b=="function"){switch(arguments.length){case 1:b.call(this);break;case 2:b.call(this,arguments[1]);break;case 3:b.call(this,arguments[1],
arguments[2]);break;default:var c=Array.prototype.slice.call(arguments,1);b.apply(this,c)}return!0}else if(beseda.events.EventEmitter.isArray(b)){for(var c=Array.prototype.slice.call(arguments,1),b=b.slice(),d=0,e=b.length;d<e;d++)b[d].apply(this,c);return!0}else return!1};
beseda.events.EventEmitter.prototype.addListener=function(a,b){if("function"!==typeof b)throw Error("addListener only takes instances of Function");if(!this._events)this._events={};this.emit("newListener",a,b);if(this._events[a])if(beseda.events.EventEmitter.isArray(this._events[a])){if(this._events[a].push(b),!this._events[a].warned){var c;if((c=this._events.maxListeners!==void 0?this._events.maxListeners:beseda.events.EventEmitter.defaultMaxListeners)&&c>0&&this._events[a].length>c)this._events[a].warned=
!0,alert("(node) warning: possible EventEmitter memory leak detected. %d listeners added. Use emitter.setMaxListeners() to increase limit. "+this._events[a].length)}}else this._events[a]=[this._events[a],b];else this._events[a]=b;return this};beseda.events.EventEmitter.prototype.on=beseda.events.EventEmitter.prototype.addListener;
beseda.events.EventEmitter.prototype.once=function(a,b){function c(){d.removeListener(a,c);b.apply(this,arguments)}if("function"!==typeof b)throw Error(".once only takes instances of Function");var d=this;c.listener=b;d.on(a,c);return this};
beseda.events.EventEmitter.prototype.removeListener=function(a,b){if("function"!==typeof b)throw Error("removeListener only takes instances of Function");if(!this._events||!this._events[a])return this;var c=this._events[a];if(beseda.events.EventEmitter.isArray(c)){for(var d=-1,e=0,g=c.length;e<g;e++)if(c[e]===b||c[e].listener&&c[e].listener===b){d=e;break}if(d<0)return this;c.splice(d,1);c.length==0&&delete this._events[a]}else(c===b||c.listener&&c.listener===b)&&delete this._events[a];return this};
beseda.events.EventEmitter.prototype.removeAllListeners=function(a){if(arguments.length===0)return this._events={},this;a&&this._events&&this._events[a]&&(this._events[a]=null);return this};beseda.events.EventEmitter.prototype.listeners=function(a){if(!this._events)this._events={};this._events[a]||(this._events[a]=[]);beseda.events.EventEmitter.isArray(this._events[a])||(this._events[a]=[this._events[a]]);return this._events[a]};
beseda.utils.cloneObject=function(a){return beseda.utils.mergeObjects({},a)};beseda.utils.mergeObjects=function(a,b){for(var c in b)try{a[c]=b[c].constructor==Object?beseda.utils.mergeObjects(a[c],b[c]):b[c]}catch(d){a[c]=b[c]}return a};beseda.utils.inherits=function(a,b){var c=function(){};c.prototype=b.prototype;a.prototype=new c;a.prototype.constructor=a};beseda.utils.log=function(a){window.console&&window.console.log(a)};beseda.utils.__base64chars="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789".split("");
beseda.utils.__base64charsLength=beseda.utils.__base64chars.length;beseda.utils.uid=function(a){for(var a=a||10,b=0,c=[];b<a;b++)c[b]=beseda.utils.__base64chars[0|Math.random()*beseda.utils.__base64charsLength];return c.join("")};
beseda.Client=function(a){beseda.events.EventEmitter.prototype.constructor.call(this);this.__options=beseda.utils.mergeObjects({host:document.location.hostname,port:4E3,ssl:!1,transports:["webSocket","longPolling","JSONPLongPolling"]},a);this._io=null;this.__status=beseda.Client.__statuses.DISCONNECTED;this.__messageQueue=[];this.__channels=[];this.router=new beseda.Router(this);this.clientId=null;this._init()};beseda.utils.inherits(beseda.Client,beseda.events.EventEmitter);
beseda.Client.__statuses={DISCONNECTED:0,CONNECTING:1,CONNECTED:2};beseda.Client.prototype._init=function(){this._io=new beseda.IO(this.__options);var a=this;this._io.addListener("message",function(b){a.router.dispatch(b)});this._io.addListener("error",function(){a.__destroy();setTimeout(function(){a.connect()},5E3)});this.__firstMessage=null;this.__handleConnectionClosure=function(b){a.clientId=b;b=a.__createMessage("/meta/connect",a.__firstMessage);a._io.send(b);a.__firstMessage=null}};
beseda.Client.prototype.isConnected=function(){return this.__status==beseda.Client.__statuses.CONNECTED};beseda.Client.prototype.isDisconnected=function(){return this.__status==beseda.Client.__statuses.DISCONNECTED};beseda.Client.prototype.isConnecting=function(){return this.__status==beseda.Client.__statuses.CONNECTING};
beseda.Client.prototype.subscribe=function(a,b,c){this.isDisconnected()&&this.connect();var d=c||{};d.subscription=a;var d=this.__sendMessage("/meta/subscribe",d),e=this;this.once("subscribe:"+d.id,function(b){b||(e.__channels[a]=d)});if(b)this.once("subscribe:"+d.id,b)};
beseda.Client.prototype.unsubscribe=function(a,b,c){this.isDisconnected()&&this.connect();c=c||{};c.subscription=a;var c=this.__sendMessage("/meta/unsubscribe",c),d=this;this.once("unsubscribe:"+c.id,function(b){b||delete d.__channels[a]});if(b)this.once("unsubscribe:"+c.id,b)};beseda.Client.prototype.publish=function(a,b,c){this.isDisconnected()&&this.connect();b=this.__sendMessage(a,{data:b});if(c)this.once("publish:"+b.id,c)};
beseda.Client.prototype.connect=function(a,b,c,d){if(!this.isConnected()){this.__status=beseda.Client.__statuses.CONNECTING;this.__firstMessage=d;if(!this._io.listeners("connect").length)this._io.on("connect",this.__handleConnectionClosure);this._io.connect(a,b,c);for(var e in this.__channels)this.__sendMessage("/meta/subscribe",this.__channels[e])}};beseda.Client.prototype.disconnect=function(){this._io.disconnect();this.__channels=[];this.__destroy();this.emit("disconnect")};
beseda.Client.prototype.applyConnection=function(){this.__status=beseda.Client.__statuses.CONNECTED;this.__flushMessageQueue()};beseda.Client.prototype.__destroy=function(){this.__status=beseda.Client.__statuses.DISCONNECTED;this.clientId=null;this.__messageQueue=[]};beseda.Client.prototype.__sendMessage=function(a,b){if(!this.isDisconnected())return b=this.__createMessage(a,b),this.isConnecting()?this.__messageQueue.push(b):this._io.send(b),b};
beseda.Client.prototype.__createMessage=function(a,b){b=b||{};b.id=beseda.utils.uid();b.channel=a;b.clientId=this.clientId;return b};beseda.Client.prototype.__flushMessageQueue=function(){for(var a=0;a<this.__messageQueue.length;a++)this.__messageQueue[a].clientId=this.clientId;this._io.send(this.__messageQueue);this.__messageQueue=[]};var Beseda=beseda.Client;beseda.Router=function(a){this.__client=a};
beseda.Router.prototype.dispatch=function(a){if(a.channel==void 0||a.clientId==void 0||a.id==void 0)this.__client.emit("error","Beseda receive incorrect message",a);else if(a.channel.indexOf("/meta/")==0){var b=a.channel.substr(6);!b in["connect","error","subscribe","unsubscribe"]?this.__client.emit("error","Unsupported meta channel "+a.channel,a):this["_"+b].call(this,a)}else"successful"in a?this._publish(a):this._message(a)};
beseda.Router.prototype._connect=function(a){a.successful?(this.__client.applyConnection(),this.__client.emit("connect",a)):(this.__client.disconnect(),this.__client.emit("error","Beseda connection request declined",a))};beseda.Router.prototype._error=function(a){this.__client.emit("error",a.data,a)};beseda.Router.prototype._subscribe=function(a){a.successful||this.__client.emit("error",a.error,a);this.__client.emit("subscribe",a.error,a);this.__client.emit("subscribe:"+a.id,a.error,a)};
beseda.Router.prototype._unsubscribe=function(a){a.successful||this.__client.emit("error",a.error,a);this.__client.emit("unsubscribe",a.error,a);this.__client.emit("unsubscribe:"+a.id,a.error,a)};beseda.Router.prototype._publish=function(a){a.successful||this.__client.emit("error",a.error,a);this.__client.emit("publish:"+a.id,a.error,a);this.__client.emit("publish",a.error,a)};
beseda.Router.prototype._message=function(a){this.__client.emit("message:"+a.channel,a.data,a);this.__client.emit("message",a.channel,a.data,a)};beseda.IO=function(a){beseda.events.EventEmitter.prototype.constructor.call(this);this.__options=a;this.__transport=beseda.Transport.getBestTransport(a);this.__transport.setEmitter(this)};beseda.utils.inherits(beseda.IO,beseda.events.EventEmitter);
beseda.IO.prototype.connect=function(a,b,c){this.__transport.connect(a||this.__options.host,b||this.__options.port,c||this.__options.ssl)};beseda.IO.prototype.send=function(a){this.__transport.send([].concat(a))};beseda.IO.prototype.disconnect=function(){this.__transport.disconnect()};beseda.Transport=function(){this._emitter=this._connectionID=this._typeSuffix=this._url=null;this._isConnected=!1;this._typeSuffix=null;this.__sendQueue=[];this.__pendingMessages={}};
beseda.Transport.__transports={longPolling:"LongPolling",JSONPLongPolling:"JSONPLongPolling",webSocket:"WebSocket"};beseda.Transport.getBestTransport=function(a){for(var b,c=0;c<a.transports.length;c++){switch(a.transports[c]){case "longPolling":b=beseda.transport.LongPolling;break;case "JSONPLongPolling":b=beseda.transport.JSONPLongPolling;break;case "webSocket":b=beseda.transport.WebSocket;break;default:throw Error("Ivalid transport "+a.transports[c]);}if(b.isAvailable(a))break}return new b};
beseda.Transport.prototype.connect=function(){throw Error("Abstract method calling.");};beseda.Transport.prototype.send=function(a){if(this._isConnected){for(var b=a.length-1;b>=0;)this.__pendingMessages[a[b].id]=!0,b--;this._doSend(JSON.stringify(a))}else this._enqueue(a)};beseda.Transport.prototype._doSend=function(){throw Error("Abstract method calling.");};beseda.Transport.prototype.disconnect=function(){throw Error("Abstract method calling.");};
beseda.Transport.prototype.setEmitter=function(a){this._emitter=a};beseda.Transport.prototype._handleConnection=function(a){this._connectionID=a;for(this._emitter&&this._emitter.emit("connect",this._connectionID);this.__sendQueue.length;)this.send(this.__sendQueue.shift())};beseda.Transport.prototype._handleMessages=function(a){for(var b;a&&a.length;)b=a.shift(),this._emitter.emit("message",b),delete this.__pendingMessages[b.id]};
beseda.Transport.prototype._handleError=function(a){var b=[],c;for(c in this.__pendingMessages)b.push(this.__pendingMessages[c]),this._emitter.emit("message:"+c,a);b.length&&this._enqueue(b);this._emitter.emit("error");this.__pendingMessages={}};beseda.Transport.prototype._decodeData=function(a){return JSON.parse(a)};beseda.Transport.prototype._enqueue=function(a){this.__sendQueue.push(a)};
beseda.transport.LongPolling=function(){beseda.Transport.prototype.constructor.call(this);this._typeSuffix="longPolling";this.__handleCloseClosure=this.__handleDataClosure=this.__handleOpenClosure=this._closeRequest=this._sendRequest=this._dataRequest=this._openRequest=this._url=null;this.__initClosuredHandlers();this._initRequests();this._initListeners()};beseda.utils.inherits(beseda.transport.LongPolling,beseda.Transport);
beseda.transport.LongPolling.isAvailable=function(a){return document.location.hostname===a.host&&(document.location.port||80)==a.port};beseda.transport.LongPolling.prototype.__initClosuredHandlers=function(){var a=this;this.__handleOpenClosure=function(b){a._handleOpen(b)};this.__handleDataClosure=function(b){a._handleData(b)};this.__handleCloseClosure=function(b){a._handleError(b)}};
beseda.transport.LongPolling.prototype._initRequests=function(){this._openRequest=new beseda.transport.request.XHRRequest("GET");this._dataRequest=new beseda.transport.request.XHRRequest("GET");this._sendRequest=new beseda.transport.request.XHRRequest("PUT");this._closeRequest=new beseda.transport.request.XHRRequest("DELETE")};
beseda.transport.LongPolling.prototype._initListeners=function(){this._openRequest.addListener("ready",this.__handleOpenClosure);this._openRequest.addListener("error",this.__handleCloseClosure);this._dataRequest.addListener("ready",this.__handleDataClosure);this._dataRequest.addListener("error",this.__handleCloseClosure)};beseda.transport.LongPolling.prototype._initURLs=function(a){this._sendRequest.url=this._dataRequest.url=this._closeRequest.url=this._url+"/"+this._typeSuffix+"/"+a};
beseda.transport.LongPolling.prototype.connect=function(a,b,c){this._url="http"+(c?"s":"")+"://"+a+(b?":"+b:"")+"/beseda/io";this._openRequest.send(this._url+"/"+this._typeSuffix)};beseda.transport.LongPolling.prototype._handleOpen=function(a){a=this._decodeData(a);this._isConnected=!0;this._initURLs(a.connectionId);beseda.Transport.prototype._handleConnection.call(this,a.connectionId);this.__poll()};beseda.transport.LongPolling.prototype._doSend=function(a){this._sendRequest.data=a;this._sendRequest.send()};
beseda.transport.LongPolling.prototype.disconnect=function(){this._closeRequest.send();this._isConnected=!1};beseda.transport.LongPolling.prototype._handleData=function(a){beseda.Transport.prototype._handleMessages.call(this,this._decodeData(a));this.__poll()};beseda.transport.LongPolling.prototype.__poll=function(){this._isConnected&&this._dataRequest.send()};beseda.transport.JSONPLongPolling=function(){beseda.transport.LongPolling.prototype.constructor.call(this);this._typeSuffix="JSONPLongPolling"};
beseda.utils.inherits(beseda.transport.JSONPLongPolling,beseda.transport.LongPolling);beseda.transport.JSONPLongPolling.isAvailable=function(){return!0};beseda.transport.JSONPLongPolling.prototype._initRequests=function(){this._openRequest=new beseda.transport.request.JSONPRequest;this._dataRequest=new beseda.transport.request.JSONPRequest;this._sendRequest=new beseda.transport.request.JSONPRequest;this._closeRequest=new beseda.transport.request.JSONPRequest};
beseda.transport.JSONPLongPolling.prototype._initURLs=function(a){beseda.transport.LongPolling.prototype._initURLs.call(this,a);this._sendRequest.url+="/send";this._closeRequest.url+="/destroy"};beseda.transport.JSONPLongPolling.prototype._decodeData=function(a){return a};beseda.transport.WebSocket=function(){beseda.Transport.prototype.constructor.call(this);this._typeSuffix="webSocket";this.__handleCloseClosure=this.__handleDataClosure=this.__handleOpenClosure=this.__ws=null;this.__initClosuredHandlers()};
beseda.utils.inherits(beseda.transport.WebSocket,beseda.Transport);beseda.transport.WebSocket.isAvailable=function(){return!!window.WebSocket};beseda.transport.WebSocket.prototype.__initClosuredHandlers=function(){var a=this;this.__handleOpenClosure=function(b){a.__handleOpen(b)};this.__handleDataClosure=function(b){a.__handleData(b)};this.__handleCloseClosure=function(b){a.__handleClose(b)}};
beseda.transport.WebSocket.prototype.connect=function(a,b,c){if(!this._isConnected)this.__ws=new WebSocket("ws"+(c?"s":"")+"://"+a+(b?":"+b:"")+"/beseda/io/"+this._typeSuffix+"/"+(new Date).getTime()),this.__ws.addEventListener("open",this.__handleOpenClosure,!1),this.__ws.addEventListener("message",this.__handleDataClosure,!1),this.__ws.addEventListener("error",this.__handleCloseClosure,!1),this.__ws.addEventListener("close",this.__handleCloseClosure,!1)};
beseda.transport.WebSocket.prototype.disconnect=function(){this.__ws.close();this._isConnected=!1};beseda.transport.WebSocket.prototype._doSend=function(a){this.__ws.send(a)};beseda.transport.WebSocket.prototype.__handleOpen=function(){this._isConnected=!0};beseda.transport.WebSocket.prototype.__handleData=function(a){a=this._decodeData(a.data);this.__handshaked?beseda.Transport.prototype._handleMessages.call(this,a):(this.__handshaked=!0,beseda.Transport.prototype._handleConnection.call(this,a.connectionId))};
beseda.transport.WebSocket.prototype.__handleClose=function(a){this._handleError(a);this.disconnect()};beseda.transport.request.XHRRequest=function(a){beseda.events.EventEmitter.prototype.constructor.call(this);this.url=null;this.method=a;this.data=null};beseda.utils.inherits(beseda.transport.request.XHRRequest,beseda.events.EventEmitter);
beseda.transport.request.XHRRequest.prototype.send=function(a){if(a)this.url=a;var a=this.url+"/"+(new Date).getTime(),b=+"\u000b1"?new XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP"),c=this;b.onreadystatechange=function(){c.__requestStateHandler(b)};this.method==="GET"&&this.data&&(a+=(a.indexOf("?")===-1?"?":"&")+this.data);b.open(this.method,encodeURI(a),!0);a=null;if(this.method!=="GET")a=this.data,b.setRequestHeader("Content-Type","application/x-www-form-urlencoded");b.send(a)};
beseda.transport.request.XHRRequest.prototype.__requestStateHandler=function(a){a.readyState===4&&(a.status===200?this.emit("ready",a.responseText):this.emit("error"),a.abort())};beseda.transport.request.JSONPRequest=function(){beseda.events.EventEmitter.prototype.constructor.call(this);this.url=null;this.data="";this.__id=++beseda.transport.request.JSONPRequest.__lastID;this.__requestIndex=0};beseda.utils.inherits(beseda.transport.request.JSONPRequest,beseda.events.EventEmitter);
beseda.transport.request.JSONPRequest.__callbacks={};beseda.transport.request.JSONPRequest.__lastID=0;beseda.transport.request.JSONPRequest.ERROR_TIMEOUT=15E3;
beseda.transport.request.JSONPRequest.prototype.send=function(a){if(a)this.url=a;var b=document.createElement("script");b.id="request_"+this.__id+"_"+this.__requestIndex;a=this.url+"/"+(new Date).getTime()+'?callback=beseda.transport.request.JSONPRequest.__callbacks["'+b.id+'"]&messages='+this.data;b.src=a;var c=this,d=setTimeout(function(){clearTimeout(d);document.body.removeChild(b);delete beseda.transport.request.JSONPRequest.__callbacks[b.id];c.emit("error")},beseda.transport.request.JSONPRequest.ERROR_TIMEOUT);
beseda.transport.request.JSONPRequest.__callbacks[b.id]=function(a){clearTimeout(d);document.body.removeChild(b);delete beseda.transport.request.JSONPRequest.__callbacks[b.id];c.emit("ready",a)};document.body.appendChild(b);this.__requestIndex++;this.data=null};

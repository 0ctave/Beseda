var b=null;
function f(a){f.h.constructor.call(this);this.options=f.r.R({host:document.location.hostname,port:4E3,la:!1,T:["longPolling","JSONPLongPolling"]},a);this.na={};this.C=f.u.I;this.ha=[];this.ka=new f.ba(this);this.D=b;this.V=[];this.l=new f.z(this.options);var c=this;this.l.S("message",function(a){var e=c.ka;if(a.m==void 0||a.D==void 0||a.id==void 0)e.g.log("Beseda receive incorrect message",a),e.g.e("error",a);else if(a.m.indexOf("/meta/")==0){var g=a.m.substr(6);!g in["connect","error","subscribe",
"unsubscribe"]?(e.g.log("Unsupported meta channel "+a.m),e.g.e("error",a)):e["_"+g].call(e,a)}else"successful"in a?(e.g.e("message:"+a.id,a.error,a),a.qa?e.g.log("Beseda publish to "+a.m,a):(e.g.log("Beseda publish request declined",a),e.g.e("error",a))):(e.g.log("Beseda get a new message from "+a.m,a),e.g.e("message:"+a.m,a.data,a),e.g.e("message",a.m,a.data,a))});this.l.S("error",function(){c.C=f.u.I;setTimeout(function(){c.v()},5E3)});this.J=b;this.F=function(a){c.D=a;a=h(c,"/meta/connect",c.J);
c.l.send(a);c.J=b;c.log("Beseda send connection request",a)}}f.k=function(){this.d={};this.ga=10};f.k.prototype.q=function(a,c){this.d[a]||(this.d[a]=[]);this.d[a].push(c);this.d[a].length>this.ga&&this.log("Warning: possible EventEmitter memory leak detected. "+this.d[a].length+" listeners added. Use emitter.setMaxListeners() to increase limit")};f.k.prototype.S=f.k.prototype.q;
function i(a,c){function d(){c.apply(a,arguments);var e=d;if(a.d.error)for(var g=0;g<a.d.error.length;g++)a.d.error[g]===e&&a.d.error.splice(g,1)}a.S("error",d)}f.k.prototype.e=function(){var a=Array.prototype.slice.call(arguments),c=a.shift();if(this.d[c])for(var d=0;d<this.d[c].length;d++)this.d[c][d].apply(this,a)};
f.r={oa:function(a){return this.R({},a)},R:function(a,c){for(var d in c)try{a[d]=c[d].constructor==Object?this.R(a[d],c[d]):c[d]}catch(e){a[d]=c[d]}return a},w:function(a,c){function d(){}d.prototype=c.prototype;a.prototype=new d;a.prototype.constructor=a;a.h=a.prototype.h=c.prototype;d=b}};f.r.w(f,f.k);
f.prototype.v=function(a,c){if(this.C==f.u.aa)return!1;this.C=f.u.CONNECTING;this.J=c;this.l.d.connect&&this.l.d.connect.indexOf(this.F)!==-1||this.l.q("connect",this.F);this.l.v();for(var d in this.V){var e=this.V[d];this.C==f.u.I||(this.C==f.u.CONNECTING?this.ha.push("/meta/subscribe",e):this.l.send(h(this,"/meta/subscribe",e)))}};f.prototype.log=function(){"console"in window&&"log"in console&&console.log.apply(console,arguments)};
function h(a,c,d){d=d||{};d.id=a.D+"_"+ ++f.fa;d.m=c;d.D=a.D;return d}f.u={I:0,CONNECTING:1,aa:2};f.fa=0;f.ba=function(a){this.g=a};f.z=function(a){f.z.h.constructor.call(this);this.K=a;this.M=f.a.ja(a);this.M.t=this};f.r.w(f.z,f.k);f.z.prototype.v=function(){this.M.v(this.K.host,this.K.port,this.K.la)};f.z.prototype.send=function(a){for(var a=[].concat(a),c=[],d=0;d<a.length;d++)c.push(a[d].id);this.M.send(JSON.stringify(a),c)};f.a=function(){this.t=this.A=this.H=this.Q=b;this.L=[]};
f.a.ia={longPolling:"LongPolling",JSONPLongPolling:"JSONPLongPolling"};f.a.ja=function(a){for(var c=0;c<a.T.length;c++){var d=f.a[f.a.ia[a.T[c]]];if(d){if(d.$(a))return new d}else throw Error("Ivalid transport "+a.T[c]);}};f.a.prototype.v=function(){throw Error("Abstract method calling.");};f.a.prototype.send=function(){throw Error("Abstract method calling.");};f.a.prototype.N=function(a){this.A=a;for(this.t&&this.t.e("connect",this.A);this.L.length;)this.send(this.L.shift())};
f.a.prototype.O=function(a){if(a)for(;a.length;)this.t.e("message",a.shift())};f.a.c=function(){f.a.c.h.constructor.call(this);this.H="longPolling";this.G=this.j=this.p=this.B=b;this.X=this.Z="";this.Y();var a=this;this.F=function(c){a.N(c)};this.ca=function(c){a.O(c)};this.W=function(){a.t.e("error")};this.da=function(){a.j.d.error=[]};this.B.q("ready",this.F);this.B.q("error",this.W);this.p.q("ready",this.ca);this.p.q("error",this.W);this.j.q("ready",this.da)};f.r.w(f.a.c,f.a);
f.a.c.$=function(a){return document.location.hostname===a.host};f.a.c.prototype.Y=function(){this.B=new f.a.c.n("GET");this.p=new f.a.c.n("GET");this.j=new f.a.c.n("PUT");this.G=new f.a.c.n("DELETE")};f.a.c.prototype.v=function(a,c,d){this.Q=(d?"https":"http")+"://"+a+":"+c+"/beseda/io";this.B.send(this.Q+"/"+this.H)};f.a.c.prototype.send=function(a,c){if(this.A){this.j.data=a;this.j.send();var d=this;i(this.j,function(a){for(var g=c.length-1;g>=0;)d.t.e("message:"+c[g],a),g--})}else this.L.push(a)};
f.a.c.prototype.N=function(a){if(a=this.P(a).pa)this.j.url=this.p.url=this.G.url=this.Q+"/"+this.H+"/"+a,this.j.url+=this.Z,this.G.url+=this.X,f.a.c.h.N.call(this,a),this.A&&this.p.send()};f.a.c.prototype.P=function(a){return JSON.parse(a)};f.a.c.prototype.O=function(a){a=this.P(a);f.a.c.h.O.call(this,a);this.A&&this.p.send()};f.a.c.n=function(a){f.a.c.n.h.constructor.call(this);this.url=b;this.method=a||"GET";this.data=b};f.r.w(f.a.c.n,f.k);
f.a.c.n.prototype.send=function(a){if(a)this.url=a;a=this.url;c!=b&&c.abort();var c=+"\u000b1"?new XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP"),d=this;c.onreadystatechange=function(){var a=c;if(a.readyState===4)a.status===200?d.e("ready",a.responseText):d.e("error"),a.onreadystatechange=b,a.abort()};this.method==="GET"&&this.data&&(a+=(a.indexOf("?")===-1?"?":"&")+this.data);c.open(this.method,encodeURI(a),!0);a=b;if(this.method!=="GET")a=this.data,c.setRequestHeader("Content-Type","application/x-www-form-urlencoded");
c.send(a)};f.a.b=function(){f.a.b.h.constructor.call(this);this.H="JSONPLongPolling";this.Z="/send";this.X="/destroy"};f.r.w(f.a.b,f.a.c);f.a.b.$=function(){return!0};f.a.b.prototype.Y=function(){this.B=new f.a.b.f;this.p=new f.a.b.f;this.j=new f.a.b.f;this.G=new f.a.b.f};f.a.b.prototype.P=function(a){return a};f.a.b.f=function(){f.a.b.f.h.constructor.call(this);this.url=b;this.data="";this.o=++f.a.b.f.ea;this.i=0;this.s={};f.a.b.f.U[this.o]={}};f.r.w(f.a.b.f,f.k);f.a.b.f.U=[];f.a.b.f.ea=0;
f.a.b.f.prototype.send=function(a){if(a)this.url=a;(function(a,d,e){f.a.b.f.U[d.o][a]=function(g){clearTimeout(e);console.log("request_"+d.o+"_"+a);document.body.removeChild(document.getElementById("request_"+d.o+"_"+a));delete d.s[a];d.e("ready",g)}})(this.i,this,function(a,d){return setTimeout(function(){document.body.removeChild(document.getElementById("request_"+d.o+"_"+a));delete d.s[a];d.e("error")},15E3)}(this.i,this));a=this.url;a+=(a.indexOf("?")===-1?"?":"&")+"callback=Beseda.Transport.JSONPLongPolling.JSONPRequest.__callbacks["+
this.o+"]["+this.i+"]&"+(new Date).getTime()+"&messages="+this.data;this.s[this.i]=document.createElement("script");this.s[this.i].src=a;this.s[this.i].id="request_"+this.o+"_"+this.i;document.body.appendChild(this.s[this.i]);this.data=b;this.i++};f.a.b.ma=function(){f.a.b.f.h.constructor.call(this);this.url=b};
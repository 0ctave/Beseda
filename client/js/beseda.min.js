var b=null;
function f(a){f.h.constructor.call(this);this.options=f.o.P({host:document.location.hostname,port:4E3,ja:!1,R:["longPolling","JSONPLongPolling"]},a);this.la={};this.B=f.s.H;this.fa=[];this.ia=new f.$(this);this.D=b;this.T=[];this.q=new f.v(this.options);var d=this;this.q.Q("message",function(a){var e=d.ia;if(a.j==void 0||a.D==void 0||a.id==void 0)e.g.log("Beseda receive incorrect message",a),e.g.e("error",a);else if(a.j.indexOf("/meta/")==0){var g=a.j.substr(6);!g in["connect","error","subscribe",
"unsubscribe"]?(e.g.log("Unsupported meta channel "+a.j),e.g.e("error",a)):e["_"+g].call(e,a)}else"successful"in a?(e.g.e("message:"+a.j+":"+a.id,a.error,a),a.oa?e.g.log("Beseda publish to "+a.j,a):(e.g.log("Beseda publish request declined",a),e.g.e("error",a))):(e.g.log("Beseda get a new message from "+a.j,a),e.g.e("message:"+a.j,a.data,a),e.g.e("message",a.j,a.data,a))});this.q.Q("error",function(){d.B=f.s.H;setTimeout(function(){d.t()},1E3)})}f.k=function(){this.f={};this.ea=10};
f.k.prototype.C=function(a,d){this.f[a]||(this.f[a]=[]);this.f[a].push(d);this.f[a].length>this.ea&&alert("Warning: possible EventEmitter memory leak detected. "+this.f[a].length+" listeners added. Use emitter.setMaxListeners() to increase limit")};f.k.prototype.Q=f.k.prototype.C;function h(a,d){function c(){d.apply(a,arguments);var e=c;if(a.f.connect)for(var g=0;g<a.f.connect.length;g++)a.f.connect[g]===e&&a.f.connect.splice(g,1)}a.Q("connect",c)}
f.k.prototype.e=function(){var a=Array.prototype.slice.call(arguments),d=a.shift();if(this.f[d])for(var c=0;c<this.f[d].length;c++)this.f[d][c].apply(this,a)};f.o={ma:function(a){return this.P({},a)},P:function(a,d){for(var c in d)try{a[c]=d[c].constructor==Object?this.P(a[c],d[c]):d[c]}catch(e){a[c]=d[c]}return a},u:function(a,d){function c(){}c.prototype=d.prototype;a.prototype=new c;a.prototype.constructor=a;a.h=a.prototype.h=d.prototype;c=b}};f.o.u(f,f.k);
f.prototype.t=function(a,d){if(this.B==f.s.Z)return!1;this.B=f.s.CONNECTING;var c=this;h(this.q,function(a){c.D=a;a=i(c,"/meta/connect",d);c.q.send(a);c.log("Beseda send connection request",a)});this.q.t();for(var e in this.T)j(this,this.T[e])};f.prototype.log=function(){"console"in window&&"log"in console&&console.log.apply(console,arguments)};
function j(a,d){if(a.B==f.s.H)throw"You must connect before send message";a.B==f.s.CONNECTING?a.fa.push("/meta/subscribe",d):a.q.send(i(a,"/meta/subscribe",d))}function i(a,d,c){c=c||{};c.id=a.D+"_"+ ++f.da;c.j=d;c.D=a.D;return c}f.s={H:0,CONNECTING:1,Z:2};f.da=0;f.$=function(a){this.g=a};f.v=function(a){f.v.h.constructor.call(this);this.I=a;this.K=f.a.ha(a);this.K.A=this};f.o.u(f.v,f.k);f.v.prototype.t=function(){this.K.t(this.I.host,this.I.port,this.I.ja)};f.v.prototype.send=function(a){this.K.send(JSON.stringify([].concat(a)))};
f.a=function(){this.A=this.w=this.G=this.O=b;this.J=[]};f.a.ga={longPolling:"LongPolling",JSONPLongPolling:"JSONPLongPolling"};f.a.ha=function(a){for(var d=0;d<a.R.length;d++){var c=f.a[f.a.ga[a.R[d]]];if(c){if(c.Y(a))return new c}else throw Error("Ivalid transport "+a.R[d]);}};f.a.prototype.t=function(){throw Error("Abstract method calling.");};f.a.prototype.send=function(){throw Error("Abstract method calling.");};f.a.prototype.L=function(a){this.w=a;for(this.A&&this.A.e("connect",this.w);this.J.length;)this.send(this.J.shift())};
f.a.prototype.M=function(a){if(a)for(;a.length;)this.A.e("message",a.shift())};f.a.c=function(){f.a.c.h.constructor.call(this);this.G="longPolling";this.F=this.r=this.n=this.z=b;this.V=this.X="";this.W();var a=this;this.aa=function(d){a.L(d)};this.ba=function(d){a.M(d)};this.U=function(){a.A.e("error")};this.z.C("ready",this.aa);this.n.C("ready",this.ba);this.z.C("error",this.U);this.n.C("error",this.U)};f.o.u(f.a.c,f.a);f.a.c.Y=function(a){return document.location.hostname===a.host};
f.a.c.prototype.W=function(){this.z=new f.a.c.l("GET");this.n=new f.a.c.l("GET");this.r=new f.a.c.l("PUT");this.F=new f.a.c.l("DELETE")};f.a.c.prototype.t=function(a,d,c){this.O=(c?"https":"http")+"://"+a+":"+d+"/beseda/io";this.z.send(this.O+"/"+this.G)};f.a.c.prototype.send=function(a){this.w?(this.r.data=a,this.r.send()):this.J.push(a)};
f.a.c.prototype.L=function(a){if(a=this.N(a).na)this.r.url=this.n.url=this.F.url=this.O+"/"+this.G+"/"+a,this.r.url+=this.X,this.F.url+=this.V,f.a.c.h.L.call(this,a),this.w&&this.n.send()};f.a.c.prototype.N=function(a){return JSON.parse(a)};f.a.c.prototype.M=function(a){a=this.N(a);f.a.c.h.M.call(this,a);this.w&&this.n.send()};f.a.c.l=function(a){f.a.c.l.h.constructor.call(this);this.url=b;this.method=a||"GET";this.data=b};f.o.u(f.a.c.l,f.k);
f.a.c.l.prototype.send=function(a){if(a)this.url=a;a=this.url;d!=b&&d.abort();var d=+"\u000b1"?new XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP"),c=this;d.onreadystatechange=function(){var a=d;if(a.readyState===4)a.status===200?c.e("ready",a.responseText):c.e("error"),a.onreadystatechange=b,a.abort()};this.method==="GET"&&this.data&&(a+=(a.indexOf("?")===-1?"?":"&")+this.data);d.open(this.method,encodeURI(a),!0);a=b;if(this.method!=="GET")a=this.data,d.setRequestHeader("Content-Type","application/x-www-form-urlencoded");
d.send(a)};f.a.b=function(){f.a.b.h.constructor.call(this);this.G="JSONPLongPolling";this.X="/send";this.V="/destroy"};f.o.u(f.a.b,f.a.c);f.a.b.Y=function(){return!0};f.a.b.prototype.W=function(){this.z=new f.a.b.d;this.n=new f.a.b.d;this.r=new f.a.b.d;this.F=new f.a.b.d};f.a.b.prototype.N=function(a){return a};f.a.b.d=function(){f.a.b.d.h.constructor.call(this);this.url=b;this.data="";this.m=++f.a.b.d.ca;this.i=0;this.p={};f.a.b.d.S[this.m]={}};f.o.u(f.a.b.d,f.k);f.a.b.d.S=[];f.a.b.d.ca=0;
f.a.b.d.prototype.send=function(a){if(a)this.url=a;(function(a,c,e){f.a.b.d.S[c.m][a]=function(g){clearTimeout(e);console.log("request_"+c.m+"_"+a);document.body.removeChild(document.getElementById("request_"+c.m+"_"+a));delete c.p[a];c.e("ready",g)}})(this.i,this,function(a,c){return setTimeout(function(){document.body.removeChild(document.getElementById("request_"+c.m+"_"+a));delete c.p[a];c.e("error")},15E3)}(this.i,this));a=this.url;a+=(a.indexOf("?")===-1?"?":"&")+"callback=Beseda.Transport.JSONPLongPolling.JSONPRequest.__callbacks["+
this.m+"]["+this.i+"]&"+(new Date).getTime()+"&messages="+this.data;this.p[this.i]=document.createElement("script");this.p[this.i].src=a;this.p[this.i].id="request_"+this.m+"_"+this.i;document.body.appendChild(this.p[this.i]);this.data=b;this.i++};f.a.b.ka=function(){f.a.b.d.h.constructor.call(this);this.url=b};
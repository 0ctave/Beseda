var Beseda=function(a){Beseda._super.constructor.call(this),this.setOptions({host:document.location.hostname,port:4e3,ssl:!1,transports:["longPolling","JSONPLongPolling"]},a),this._events={},this._status=Beseda._statuses.DISCONNECTED,this._messageQueue=[],this.router=new Beseda.Router(this),this.clientId=null,this._io=new Beseda.IO(this.options);var b=this;this._io.on("message",function(a){b.router.dispatch(a)}),this._io.on("disconnect",function(){b._onDisconnect()})};Beseda.EventEmitter=function(){this.__events={}},Beseda.EventEmitter.prototype.addListener=function(a,b){this.__events[a]||(this.__events[a]=[]),this.__events[a].push(b)},Beseda.EventEmitter.prototype.on=Beseda.EventEmitter.prototype.addListener,Beseda.EventEmitter.prototype.once=function(a,b){var c=this,d=function(){b.apply(c,arguments),c.removeListener(a,d)};this.on(a,d)},Beseda.EventEmitter.prototype.removeListener=function(a,b){if(this.__events[a])for(var c=0;c<this.__events[a].length;c++)this.__events[a][c]===b&&this.__events[a].splice(c,1)},Beseda.EventEmitter.prototype.removeAllListeners=function(a){this.__events[a]=[]},Beseda.EventEmitter.prototype.emit=function(){var a=Array.prototype.slice.call(arguments),b=a.shift();if(this.__events[b])for(var c=0;c<this.__events[b].length;c++)this.__events[b][c].apply(this,a)},Beseda.EventEmitter.prototype.listeners=function(a){return this.__events[a]||[]},Beseda.utils={cloneObject:function(a){return this.mergeObjects({},a)},mergeObjects:function(a,b){for(var c in b)try{b[c].constructor==Object?a[c]=this.mergeObjects(a[c],b[c]):a[c]=b[c]}catch(d){a[c]=b[c]}return a},inherits:function(a,b){var c=function(){};c.prototype=b.prototype,a.prototype=new c,a.prototype.constructor=a,a._super=a.prototype._super=b.prototype,c=null}},Beseda.utils.inherits(Beseda,Beseda.EventEmitter),Beseda.prototype.isConnected=function(){return this._status==Beseda._statuses.CONNECTED},Beseda.prototype.isDisconnected=function(){return this._status==Beseda._statuses.DISCONNECTED},Beseda.prototype.isConnecting=function(){return this._status==Beseda._statuses.CONNECTING},Beseda.prototype.subscribe=function(a,b,c){this.isDisconnected()&&this.connect();var d=c||{};d.subscription=a,d=this._sendMessage("/meta/subscribe",d),this.log("Beseda send subscribe request",d),b&&this.on("subscribe:"+d.id,b)},Beseda.prototype.unsubscribe=function(a,b,c){this.isDisconnected()&&this.connect();var d=c||{};d.subscription=a,d=this._sendMessage("/meta/unsubscribe",d),this.log("Beseda send unsubscribe request",d),b&&this.on("unsubscribe:"+d.id,b)},Beseda.prototype.publish=function(a,b,c){this.isDisconnected()&&this.connect(),b=this._sendMessage(a,{data:b}),this.log("Beseda send publish request",b),c&&this.on("message:"+a+":"+b.id,c);return this},Beseda.prototype.connect=function(a,b){if(this.isConnected())return!1;this._status=Beseda._statuses.CONNECTING;var c=this;this._io.once("connect",function(a){c.clientId=a;var d=c._createMessage("/meta/connect",b);c._io.send(d),c.log("Beseda send connection request",d)}),this._io.connect()},Beseda.prototype.disconnect=function(){this._io.disconnect()},Beseda.prototype.setOptions=function(a,b){this.options=Beseda.utils.mergeObjects(a,b)},Beseda.prototype.log=function(){"console"in window&&"log"in console&&console.log.apply(console,arguments)},Beseda.prototype._sendMessage=function(a,b){if(this.isDisconnected())throw"You must connect before send message";this.isConnecting()?this._messageQueue.push(a,b):this._io.send(this._createMessage(a,b));return b},Beseda.prototype._createMessage=function(a,b){b=b||{},b.id=this.clientId+"_"+ ++Beseda.__lastMessageID,b.channel=a,b.clientId=this.clientId;return JSON.stringify(b)},Beseda.prototype._onDisconnect=function(){this._status=Beseda._statuses.DISCONNECTED,this.emit("disconnect"),this.log("Beseda disconnected")},Beseda.prototype.flushMessageQueue=function(){while(this._messageQueue.length)this._io.send(this._createMessage(this._messageQueue.shift(),this._messageQueue.shift()))},Beseda._statuses={DISCONNECTED:0,CONNECTING:1,CONNECTED:2},Beseda.__lastMessageID=0,Beseda.Router=function(a){this.client=a},Beseda.Router.prototype.dispatch=function(a){if(a.channel==undefined||a.clientId==undefined||a.id==undefined)this.client.log("Beseda receive incorrect message",a),this.client.emit("error",a);else if(a.channel.indexOf("/meta/")==0){var b=a.channel.substr(6);!b in["connect","error","subscribe","unsubscribe"]?(this.client.log("Unsupported meta channel "+a.channel),this.client.emit("error",a)):this["_"+b].call(this,a)}else this._message(a)},Beseda.Router.prototype._connect=function(a){a.successful?(this.client._status=Beseda._statuses.CONNECTED,this.client.flushMessageQueue(),this.client.log("Beseda connected"),this.client.emit("connection",a)):(this.client.disconnect(),this.client.log("Beseda connection request declined",a),this.client.emit("error",a))},Beseda.Router.prototype._error=function(a){this.client.log("Beseda error: "+a.data),this.client.emit("error",a)},Beseda.Router.prototype._subscribe=function(a){a.successful?this.client.log("Beseda subscribed to "+a.subscription.toString(),a):(this.client.log("Beseda subscribe request declined",a),this.client.emit("error",a)),this.client.emit("subscribe",a.error,a),this.client.emit("subscribe:"+a.id,a.error,a)},Beseda.Router.prototype._unsubscribe=function(a){a.successful?this.client.log("Beseda unsubscribed from "+a.subscription.toString(),a):(this.client.log("Beseda unsubscribe request declined",a),this.client.emit("error",a)),this.client.emit("unsubscribe",a.error,a),this.client.emit("unsubscribe:"+a.id,a.error,a)},Beseda.Router.prototype._message=function(a){"successful"in a?(this.client.emit("message:"+a.channel+":"+a.id,a.error,a),a.successful?this.client.log("Beseda publish to "+a.channel,a):(this.client.log("Beseda publish request declined",a),this.client.emit("error",a))):(this.client.log("Beseda get a new message from "+a.channel,a),this.client.emit("message:"+a.channel,a.data,a),this.client.emit("message",a.channel,a.data,a))},Beseda.IO=function(a){Beseda.IO._super.constructor.call(this),this.__options=a,this.__transport=Beseda.Transport.getBestTransport(a),this.__transport.setEmitter(this)},Beseda.utils.inherits(Beseda.IO,Beseda.EventEmitter),Beseda.IO.prototype.connect=function(){this.__transport.connect(this.__options.host,this.__options.port,this.__options.ssl)},Beseda.IO.prototype.send=function(a){this.__transport.send(a)},Beseda.IO.prototype.disconnect=function(){this.__transport.disconnect()},Beseda.Transport=function(){this._url=null,this._typeSuffix=null,this._connectionID=null,this._emitter=null,this.__sendQueue=[]},Beseda.Transport.DATA_SEPARATOR="|",Beseda.Transport._transports={longPolling:"LongPolling",JSONPLongPolling:"JSONPLongPolling"},Beseda.Transport.getBestTransport=function(a){for(var b=0;b<a.transports.length;b++){var c=Beseda.Transport._transports[a.transports[b]],d=Beseda.Transport[c];if(!d)throw Error("Ivalid transport "+a.transports[b]);if(d.isAvailable(a))return new d}},Beseda.Transport.prototype.connect=function(a,b,c){throw Error("Abstract method calling.")},Beseda.Transport.prototype.send=function(a){throw Error("Abstract method calling.")},Beseda.Transport.prototype.disconnect=function(){throw Error("Abstract method calling.")},Beseda.Transport.prototype.setEmitter=function(a){this._emitter=a},Beseda.Transport.prototype._handleConnection=function(a){this._connectionID=a,this._emitter&&this._emitter.emit("connect",this._connectionID);while(this.__sendQueue.length)this.send(this.__sendQueue.shift())},Beseda.Transport.prototype._handleMessage=function(data){if(data){var messages;messages=data;if(!messages.pop)try{var parsedData=eval("("+data+")");messages=parsedData.messages}catch(error){}while(messages&&messages.length)this._emitter.emit("message",messages.shift())}},Beseda.Transport.prototype._enqueue=function(a){this.__sendQueue.push(a)},Beseda.Transport.LongPolling=function(){Beseda.Transport.LongPolling._super.constructor.call(this),this._typeSuffix="longPolling",this._connectionRequest=null,this._pollRequest=null,this._sendRequest=null,this._sendSuffix="",this._initRequests();var a=this;this.__handleConnectionClosure=function(b){a._handleConnection(b)},this.__handleMessageClosure=function(b){a._handleMessage(b)},this._connectionRequest.addListener("ready",this.__handleConnectionClosure),this._pollRequest.addListener("ready",this.__handleMessageClosure)},Beseda.utils.inherits(Beseda.Transport.LongPolling,Beseda.Transport),Beseda.Transport.LongPolling.isAvailable=function(a){return!1},Beseda.Transport.LongPolling.prototype._initRequests=function(){this._connectionRequest=new Beseda.Transport.LongPolling.Request("GET"),this._pollRequest=new Beseda.Transport.LongPolling.Request("GET"),this._sendRequest=new Beseda.Transport.LongPolling.Request("POST")},Beseda.Transport.LongPolling.prototype.connect=function(a,b,c){if(!this._url){var d=c?"https":"http";this._url=d+"://"+a+":"+b+"/beseda/io";var e=this._url+"/"+this._typeSuffix;this._connectionRequest.send(e)}},Beseda.Transport.LongPolling.prototype._handleConnection=function(data){if(data!==undefined){var id=data.connectionId;if(id==null)try{id=eval("("+data+")").connectionId}catch(error){}id&&(this._sendRequest.url=this._pollRequest.url=this._url+"/"+this._typeSuffix+"/"+id,this._sendRequest.url+=this._sendSuffix,Beseda.Transport.LongPolling._super._handleConnection.call(this,id),this.__poll())}},Beseda.Transport.LongPolling.prototype.__poll=function(){this._connectionID&&this._pollRequest.send()},Beseda.Transport.LongPolling.prototype._handleMessage=function(a){Beseda.Transport.LongPolling._super._handleMessage.call(this,a),this.__poll()},Beseda.Transport.LongPolling.prototype.send=function(a){this._connectionID?(this._sendRequest.data="["+a+"]",this._sendRequest.send()):this._enqueue(a)},Beseda.Transport.LongPolling.Request=function(a){Beseda.Transport.LongPolling.Request._super.constructor.call(this),this.url=null,this.method=a||"GET",this.data=null},Beseda.utils.inherits(Beseda.Transport.LongPolling.Request,Beseda.EventEmitter),Beseda.Transport.LongPolling.Request.prototype.__requestStateHandler=function(a){a.readyState===4&&(this.emit("ready",a.responseText),a.abort())},Beseda.Transport.LongPolling.Request.prototype.send=function(a){a&&(this.url=a);var b=this.url;c!=null&&c.abort();var c=0?new ActiveXObject("Microsoft.XMLHTTP"):new XMLHttpRequest,d=this;c.onreadystatechange=function(){d.__requestStateHandler(c)},this.method==="GET"&&this.data&&(b+=(b.indexOf("?")===-1?"?":"&")+this.data),c.open(this.method,encodeURI(b),!0);var e=null;this.method==="POST"&&(e=this.data,c.setRequestHeader("Content-Type","application/x-www-form-urlencoded")),c.send(e)},Beseda.Transport.JSONPLongPolling=function(){Beseda.Transport.JSONPLongPolling._super.constructor.call(this),this._typeSuffix="JSONPLongPolling",this._sendSuffix="/send"},Beseda.utils.inherits(Beseda.Transport.JSONPLongPolling,Beseda.Transport.LongPolling),Beseda.Transport.JSONPLongPolling.isAvailable=function(a){return!0},Beseda.Transport.JSONPLongPolling.prototype._initRequests=function(){this._connectionRequest=new Beseda.Transport.JSONPLongPolling.JSONPRequest,this._pollRequest=new Beseda.Transport.JSONPLongPolling.JSONPRequest,this._sendRequest=new Beseda.Transport.JSONPLongPolling.JSONPRequest},Beseda.Transport.JSONPLongPolling.JSONPRequest=function(){Beseda.Transport.JSONPLongPolling.JSONPRequest._super.constructor.call(this),this.url=null,this.data="",this.__id=Beseda.Transport.JSONPLongPolling.JSONPRequest.__lastID++,this.__script=null;var a=this;Beseda.Transport.JSONPLongPolling.JSONPRequest.__callbacks[this.__id]=function(b){a.__handleData(b)}},Beseda.utils.inherits(Beseda.Transport.JSONPLongPolling.JSONPRequest,Beseda.EventEmitter),Beseda.Transport.JSONPLongPolling.JSONPRequest.__callbacks=[],Beseda.Transport.JSONPLongPolling.JSONPRequest.__lastID=0,Beseda.Transport.JSONPLongPolling.JSONPRequest.prototype.__handleData=function(a){document.body.removeChild(this.__script),this.__script=null,this.emit("ready",a)},Beseda.Transport.JSONPLongPolling.JSONPRequest.prototype.send=function(a){a&&(this.url=a);var b=this.url;b+=(b.indexOf("?")===-1?"?":"&")+"callback=Beseda.Transport.JSONPLongPolling.JSONPRequest.__callbacks["+this.__id+"]&"+(new Date).getTime()+"&messages="+this.data,this.__script=document.createElement("script"),this.__script.src=b,this.__script.async="async",document.body.appendChild(this.__script),this.data=null},Beseda.Transport.JSONPLongPolling.FormRequest=function(){Beseda.Transport.JSONPLongPolling.JSONPRequest._super.constructor.call(this),this.url=null}
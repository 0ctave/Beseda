var b=null;
function f(a){f.h.constructor.call(this);this.options=f.p.P({host:document.location.hostname,port:4E3,ga:!1,Q:["longPolling","JSONPLongPolling"]},a);this.ia={};this.t=f.o.F;this.ca=[];this.fa=new f.Y(this);this.D=b;this.S=[];this.m=new f.w(this.options);var c=this;this.m.H("message",function(a){var e=c.fa;if(a.j==void 0||a.D==void 0||a.id==void 0)e.f.log("Beseda receive incorrect message",a),e.f.d("error",a);else if(a.j.indexOf("/meta/")==0){var g=a.j.substr(6);!g in["connect","error","subscribe",
"unsubscribe"]?(e.f.log("Unsupported meta channel "+a.j),e.f.d("error",a)):e["_"+g].call(e,a)}else"successful"in a?(e.f.d("message:"+a.j+":"+a.id,a.error,a),a.la?e.f.log("Beseda publish to "+a.j,a):(e.f.log("Beseda publish request declined",a),e.f.d("error",a))):(e.f.log("Beseda get a new message from "+a.j,a),e.f.d("message:"+a.j,a.data,a),e.f.d("message",a.j,a.data,a))});this.m.H("disconnect",function(){c.t=f.o.F;c.d("disconnect");c.log("Beseda disconnected")});this.m.H("error",function(){c.t=f.o.F;
setTimeout(function(){c.u()},1E3)})}f.k=function(){this.g={}};f.k.prototype.C=function(a,c){this.g[a]||(this.g[a]=[]);this.g[a].push(c)};f.k.prototype.H=f.k.prototype.C;function h(a,c){function d(){c.apply(a,arguments);var e=d;if(a.g.connect)for(var g=0;g<a.g.connect.length;g++)a.g.connect[g]===e&&a.g.connect.splice(g,1)}a.H("connect",d)}f.k.prototype.d=function(){var a=Array.prototype.slice.call(arguments),c=a.shift();if(this.g[c])for(var d=0;d<this.g[c].length;d++)this.g[c][d].apply(this,a)};
f.p={ja:function(a){return this.P({},a)},P:function(a,c){for(var d in c)try{a[d]=c[d].constructor==Object?this.P(a[d],c[d]):c[d]}catch(e){a[d]=c[d]}return a},v:function(a,c){function d(){}d.prototype=c.prototype;a.prototype=new d;a.prototype.constructor=a;a.h=a.prototype.h=c.prototype;d=b}};f.p.v(f,f.k);
f.prototype.u=function(a,c){if(this.t==f.o.X)return!1;this.t=f.o.CONNECTING;var d=this;h(this.m,function(a){d.D=a;a=i(d,"/meta/connect",c);d.m.send(a);d.log("Beseda send connection request",a)});this.m.u();for(var e in this.S)j(this,this.S[e])};f.prototype.log=function(){"console"in window&&"log"in console&&console.log.apply(console,arguments)};
function j(a,c){if(a.t==f.o.F)throw"You must connect before send message";a.t==f.o.CONNECTING?a.ca.push("/meta/subscribe",c):a.m.send(i(a,"/meta/subscribe",c))}function i(a,c,d){d=d||{};d.id=a.D+"_"+ ++f.ba;d.j=c;d.D=a.D;return d}f.o={F:0,CONNECTING:1,X:2};f.ba=0;f.Y=function(a){this.f=a};f.w=function(a){f.w.h.constructor.call(this);this.I=a;this.K=f.a.ea(a);this.K.B=this};f.p.v(f.w,f.k);f.w.prototype.u=function(){this.K.u(this.I.host,this.I.port,this.I.ga)};f.w.prototype.send=function(a){this.K.send(JSON.stringify([].concat(a)))};
f.a=function(){this.B=this.z=this.G=this.O=b;this.J=[]};f.a.da={longPolling:"LongPolling",JSONPLongPolling:"JSONPLongPolling"};f.a.ea=function(a){for(var c=0;c<a.Q.length;c++){var d=f.a[f.a.da[a.Q[c]]];if(d){if(d.W(a))return new d}else throw Error("Ivalid transport "+a.Q[c]);}};f.a.prototype.u=function(){throw Error("Abstract method calling.");};f.a.prototype.send=function(){throw Error("Abstract method calling.");};f.a.prototype.L=function(a){this.z=a;for(this.B&&this.B.d("connect",this.z);this.J.length;)this.send(this.J.shift())};
f.a.prototype.M=function(a){if(a)for(;a.length;)this.B.d("message",a.shift())};f.a.c=function(){f.a.c.h.constructor.call(this);this.G="longPolling";this.s=this.n=this.A=b;this.V="";this.U();var a=this;this.Z=function(c){a.L(c)};this.$=function(c){a.M(c)};this.T=function(){a.B.d("error")};this.A.C("ready",this.Z);this.n.C("ready",this.$);this.A.C("error",this.T);this.n.C("error",this.T)};f.p.v(f.a.c,f.a);f.a.c.W=function(){return!1};
f.a.c.prototype.U=function(){this.A=new f.a.c.q("GET");this.n=new f.a.c.q("GET");this.s=new f.a.c.q("POST")};f.a.c.prototype.u=function(a,c,d){this.O=(d?"https":"http")+"://"+a+":"+c+"/beseda/io";this.A.send(this.O+"/"+this.G)};f.a.c.prototype.L=function(a){if(a=this.N(a).ka)this.s.url=this.n.url=this.O+"/"+this.G+"/"+a,this.s.url+=this.V,f.a.c.h.L.call(this,a),this.z&&this.n.send()};f.a.c.prototype.N=function(a){return JSON.parse(a)};
f.a.c.prototype.M=function(a){a=this.N(a);f.a.c.h.M.call(this,a);this.z&&this.n.send()};f.a.c.prototype.send=function(a){this.z?(this.s.data=a,this.s.send()):this.J.push(a)};f.a.c.q=function(a){f.a.c.q.h.constructor.call(this);this.url=b;this.method=a||"GET";this.data=b};f.p.v(f.a.c.q,f.k);
f.a.c.q.prototype.send=function(a){if(a)this.url=a;a=this.url;c!=b&&c.abort();var c=+"\u000b1"?new XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP"),d=this;c.onreadystatechange=function(){var a=c;if(a.readyState===4)a.status===200?d.d("ready",a.responseText):d.d("error"),a.onreadystatechange=b,a.abort()};this.method==="GET"&&this.data&&(a+=(a.indexOf("?")===-1?"?":"&")+this.data);c.open(this.method,encodeURI(a),!0);a=b;if(this.method==="POST")a=this.data,c.setRequestHeader("Content-Type","application/x-www-form-urlencoded");
c.send(a)};f.a.b=function(){f.a.b.h.constructor.call(this);this.G="JSONPLongPolling";this.V="/send"};f.p.v(f.a.b,f.a.c);f.a.b.W=function(){return!0};f.a.b.prototype.U=function(){this.A=new f.a.b.e;this.n=new f.a.b.e;this.s=new f.a.b.e};f.a.b.prototype.N=function(a){return a};f.a.b.e=function(){f.a.b.e.h.constructor.call(this);this.url=b;this.data="";this.l=++f.a.b.e.aa;this.i=0;this.r={};f.a.b.e.R[this.l]={}};f.p.v(f.a.b.e,f.k);f.a.b.e.R=[];f.a.b.e.aa=0;
f.a.b.e.prototype.send=function(a){if(a)this.url=a;(function(a,d,e){f.a.b.e.R[d.l][a]=function(g){clearTimeout(e);console.log("request_"+d.l+"_"+a);document.body.removeChild(document.getElementById("request_"+d.l+"_"+a));delete d.r[a];d.d("ready",g)}})(this.i,this,function(a,d){return setTimeout(function(){document.body.removeChild(document.getElementById("request_"+d.l+"_"+a));delete d.r[a];d.d("error")},15E3)}(this.i,this));a=this.url;a+=(a.indexOf("?")===-1?"?":"&")+"callback=Beseda.Transport.JSONPLongPolling.JSONPRequest.__callbacks["+
this.l+"]["+this.i+"]&"+(new Date).getTime()+"&messages="+this.data;this.r[this.i]=document.createElement("script");this.r[this.i].src=a;this.r[this.i].id="request_"+this.l+"_"+this.i;document.body.appendChild(this.r[this.i]);this.data=b;this.i++};f.a.b.ha=function(){f.a.b.e.h.constructor.call(this);this.url=b};